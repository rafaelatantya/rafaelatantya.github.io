<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPB Course Explorer - Static</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .progress-bar { transition: width 0.2s ease-in-out; }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff;
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        body.loading { overflow: hidden; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans loading">

    <div id="loadingOverlay">
        <div class="w-full max-w-lg p-8">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800">Memuat Database</h2>
                <p class="text-gray-500 text-sm">Menghubungkan 15 fragmen data...</p>
            </div>

            <div class="flex justify-between items-end mb-2">
                <div class="text-gray-500 text-xs font-semibold tracking-wider">DOWNLOAD SPEED</div>
                <div id="downloadSpeed" class="text-3xl font-mono font-bold text-blue-600">0 KB/s</div>
            </div>
            
            <div class="w-full bg-gray-200 rounded-lg h-4 mb-2 overflow-hidden shadow-inner">
                <div id="progressBar" class="bg-blue-600 h-4 rounded-lg progress-bar" style="width: 0%"></div>
            </div>

            <div class="flex justify-between text-xs text-gray-500 font-mono mb-6">
                <span id="filesCount">File: 0/15</span>
                <span id="percentText">0%</span>
            </div>

            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="bg-gray-50 p-2 rounded border border-gray-100">
                    <div class="text-[10px] text-gray-400 uppercase">Total Size</div>
                    <div id="dataSize" class="text-sm font-semibold text-gray-700">0 MB</div>
                </div>
                <div class="bg-gray-50 p-2 rounded border border-gray-100">
                    <div class="text-[10px] text-gray-400 uppercase">Est. Time</div>
                    <div id="etr" class="text-sm font-semibold text-gray-700">--</div>
                </div>
                <div class="bg-gray-50 p-2 rounded border border-gray-100">
                    <div class="text-[10px] text-gray-400 uppercase">Status</div>
                    <div id="currentStatus" class="text-sm font-semibold text-green-600">Init</div>
                </div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden max-w-5xl mx-auto p-6">
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-blue-900 tracking-tight">IPB Course Explorer</h1>
            <p class="text-gray-600 mt-2">Database Offline &bull; <span id="totalDataBadge" class="font-bold text-blue-600">0</span> Mata Kuliah</p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 sticky top-4 z-10">
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="searchInput" placeholder="Cari Kode (BIO100) atau Nama (Kalkulus)..." 
                    class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                
                <select id="strataSelect" class="border border-gray-300 rounded-lg px-4 py-3 bg-white min-w-[150px]">
                    <option value="ALL">Semua Strata</option>
                </select>

                <button id="btnSearch" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-md active:transform active:scale-95">
                    CARI
                </button>
            </div>
        </div>

        <div id="resultsContainer" class="space-y-4 mt-6">
            <div class="text-center text-gray-400 py-10">Data siap. Masukkan kata kunci untuk mencari.</div>
        </div>
        
        <div class="text-center mt-8 mb-10">
            <button id="loadMoreBtn" class="hidden bg-white border border-gray-300 text-gray-700 px-6 py-2 rounded-full hover:bg-gray-50 shadow font-medium transition">
                Tampilkan Lebih Banyak
            </button>
        </div>
    </div>

    <script>
        // === KONFIGURASI ===
        const TOTAL_FILES = 15;
        const FILE_PREFIX = 'merged_db/db_matkul_';
        
        // === STATE GLOBAL ===
        let ALL_DATA = [];
        let totalBytesLoaded = 0;
        let startTime = null;

        // === UI ELEMENTS ===
        const uiElements = {
            progress: document.getElementById('progressBar'),
            filesCount: document.getElementById('filesCount'),
            percentText: document.getElementById('percentText'),
            dataSize: document.getElementById('dataSize'),
            speed: document.getElementById('downloadSpeed'),
            etr: document.getElementById('etr'),
            status: document.getElementById('currentStatus'),
            overlay: document.getElementById('loadingOverlay'),
            mainApp: document.getElementById('mainApp')
        };
        
        // === LOGIC UTAMA ===
        async function loadDatabase() {
            startTime = Date.now();
            uiElements.status.innerText = "Downloading...";
            
            for (let i = 1; i <= TOTAL_FILES; i++) {
                const fileName = `${FILE_PREFIX}${i}.json`;
                
                try {
                    const response = await fetch(fileName);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    // 1. Ambil Data & Size
                    const blob = await response.blob();
                    const size = blob.size;
                    totalBytesLoaded += size;
                    
                    const text = await blob.text();
                    const json = JSON.parse(text);
                    
                    // 2. Gabung Data (Looping push lebih aman memori dibanding spread operator)
                    for(const item of json) {
                        const finalItem = item.Details ? item.Details : item;
                        if(finalItem) ALL_DATA.push(finalItem);
                    }

                    // 3. Kalkulasi Speed & Progress
                    const now = Date.now();
                    const elapsedSec = (now - startTime) / 1000; // detik
                    
                    // Hitung Speed (Bytes per second)
                    const bps = elapsedSec > 0 ? totalBytesLoaded / elapsedSec : 0;
                    
                    // Format Speed Text
                    let speedText = '';
                    if (bps > 1024 * 1024) {
                        speedText = (bps / (1024 * 1024)).toFixed(1) + ' MB/s';
                    } else {
                        speedText = (bps / 1024).toFixed(0) + ' KB/s';
                    }

                    // Progress Math
                    const progressPercent = (i / TOTAL_FILES) * 100;
                    
                    // Estimasi Sisa Waktu
                    // Rata-rata size per file * sisa file / speed
                    const avgSizePerFile = totalBytesLoaded / i;
                    const remainingFiles = TOTAL_FILES - i;
                    const estRemainingBytes = avgSizePerFile * remainingFiles;
                    const remainingSec = bps > 0 ? estRemainingBytes / bps : 0;

                    // 4. Update UI Realtime
                    uiElements.progress.style.width = `${progressPercent}%`;
                    uiElements.percentText.innerText = `${Math.round(progressPercent)}%`;
                    uiElements.filesCount.innerText = `File: ${i}/${TOTAL_FILES}`;
                    uiElements.speed.innerText = speedText;
                    uiElements.dataSize.innerText = (totalBytesLoaded / (1024*1024)).toFixed(2) + ' MB';
                    
                    if (remainingSec > 0 && i < TOTAL_FILES) {
                        uiElements.etr.innerText = remainingSec < 1 ? '< 1s' : remainingSec.toFixed(0) + 's';
                    } else {
                        uiElements.etr.innerText = '0s';
                    }

                } catch (err) {
                    console.error(err);
                    uiElements.status.innerText = "Error!";
                    uiElements.status.classList.add('text-red-600');
                }
            }

            // Selesai
            uiElements.status.innerText = "Processing...";
            finishLoading();
        }

        function finishLoading() {
            setTimeout(() => {
                // Fade out animation
                uiElements.overlay.style.opacity = '0';
                uiElements.overlay.style.transition = 'opacity 0.5s ease';
                
                setTimeout(() => {
                    uiElements.overlay.style.display = 'none';
                    uiElements.mainApp.classList.remove('hidden');
                    document.body.classList.remove('loading');
                    
                    initApp();
                }, 500);
            }, 800);
        }

        // === SEARCH LOGIC ===
        let searchResults = [];
        let currentPage = 1;
        const LIMIT = 20;

        function initApp() {
            // Update Badge Total
            document.getElementById('totalDataBadge').innerText = ALL_DATA.length.toLocaleString();
            
            // Populate Strata Dropdown
            const strataSet = new Set(ALL_DATA.map(c => c.Strata).filter(Boolean));
            const select = document.getElementById('strataSelect');
            [...strataSet].sort().forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.innerText = s;
                select.appendChild(opt);
            });
        }

        // Event Listeners
        document.getElementById('btnSearch').addEventListener('click', () => doSearch(true));
        document.getElementById('loadMoreBtn').addEventListener('click', () => {
            currentPage++;
            renderPage();
        });
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') doSearch(true);
        });

        // Helper Toggle Jadwal
        window.toggleJadwal = function(id) {
            const el = document.getElementById(`jadwal-${id}`);
            el.classList.toggle('hidden');
        }

        function doSearch(reset = true) {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const strataFilter = document.getElementById('strataSelect').value;
            const container = document.getElementById('resultsContainer');

            if (reset) {
                currentPage = 1;
                container.innerHTML = '';
                
                // Filter Logic
                searchResults = ALL_DATA.filter(item => {
                    const matchStrata = (strataFilter === 'ALL') || (item.Strata === strataFilter);
                    const matchKeyword = !keyword || 
                                         (item.Nama && item.Nama.toLowerCase().includes(keyword)) || 
                                         (item.Kode && item.Kode.toLowerCase().includes(keyword));
                    return matchStrata && matchKeyword;
                });

                if (searchResults.length === 0) {
                    container.innerHTML = `<div class="text-center text-gray-500 py-10">Tidak ditemukan mata kuliah dengan kata kunci tersebut.</div>`;
                    document.getElementById('loadMoreBtn').classList.add('hidden');
                    return;
                }
            }
            renderPage();
        }

        function renderPage() {
            const container = document.getElementById('resultsContainer');
            const start = (currentPage - 1) * LIMIT;
            const end = start + LIMIT;
            const slice = searchResults.slice(start, end);

            slice.forEach(item => {
                const strataColor = item.Strata === 'S1' ? 'bg-green-100 text-green-800' : 
                                    (item.Strata === 'S2' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800');

                let jadwalHtml = '';
                if (item.ListJadwal && item.ListJadwal.length > 0) {
                    jadwalHtml = `<div class="hidden mt-4 p-4 bg-gray-50 rounded-lg border border-gray-100 text-sm" id="jadwal-${item.MataKuliahId}">
                        <h4 class="font-bold text-gray-700 mb-2">Jadwal Perkuliahan:</h4>
                        <ul class="space-y-2">
                            ${item.ListJadwal.map(j => `
                                <li class="flex items-start gap-2">
                                    <span class="font-bold text-blue-600 bg-blue-50 px-2 rounded text-xs whitespace-nowrap">Kelas ${j.KelasParalel}</span>
                                    <span class="text-gray-600">${j.Jadwal.join(', ')}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>`;
                } else {
                    jadwalHtml = `<div class="hidden mt-4 text-sm text-gray-400 italic p-2" id="jadwal-${item.MataKuliahId}">Jadwal belum tersedia.</div>`;
                }

                const card = `
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition duration-200">
                        <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-2">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="px-2 py-0.5 text-xs font-bold rounded ${strataColor}">${item.Strata || 'N/A'}</span>
                                    <span class="text-xs text-gray-400 font-mono">#${item.MataKuliahId}</span>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 leading-tight">${item.Nama}</h3>
                                <div class="text-blue-600 font-mono text-sm mt-1 font-medium">${item.Kode} &bull; ${item.SksNama}</div>
                            </div>
                            <div class="mt-2 md:mt-0 flex-shrink-0">
                                <button onclick="toggleJadwal('${item.MataKuliahId}')" 
                                    class="text-xs font-semibold bg-blue-50 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-100 transition border border-blue-100">
                                    ${item.ListJadwal ? item.ListJadwal.length : 0} JADWAL
                                </button>
                            </div>
                        </div>
                        ${jadwalHtml}
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', card);
            });

            // Handle Tombol Load More
            const btn = document.getElementById('loadMoreBtn');
            if (end >= searchResults.length) {
                btn.classList.add('hidden');
            } else {
                btn.classList.remove('hidden');
                btn.innerText = `Tampilkan Lagi (${searchResults.length - end} tersisa)`;
            }
        }

        // Start
        loadDatabase();

    </script>
</body>
</html>