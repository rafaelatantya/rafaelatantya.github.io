<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPB Course Explorer - Final Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .progress-bar { transition: width 0.2s ease-in-out; }
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 50;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        body.loading { overflow: hidden; }
        /* Hapus margin default dari konten deskripsi bawaan API */
        .desc-content p { margin-bottom: 0.5rem; }
        .desc-content ul { list-style-type: disc; margin-left: 1.5rem; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans loading">

    <div id="loadingOverlay">
        <div class="w-full max-w-lg p-8">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-slate-800">Memuat Database IPB</h2>
                <p class="text-slate-500 text-sm">Menghubungkan fragmen data JSON...</p>
            </div>
            <div class="flex justify-between items-end mb-2">
                <div class="text-slate-500 text-xs font-semibold tracking-wider">DOWNLOAD SPEED</div>
                <div id="downloadSpeed" class="text-3xl font-mono font-bold text-blue-600">0 KB/s</div>
            </div>
            <div class="w-full bg-slate-200 rounded-lg h-4 mb-2 overflow-hidden shadow-inner">
                <div id="progressBar" class="bg-blue-600 h-4 rounded-lg progress-bar" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-xs text-slate-500 font-mono mb-6">
                <span id="filesCount">File: 0/15</span>
                <span id="percentText">0%</span>
            </div>
            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="bg-slate-50 p-2 rounded border border-slate-200">
                    <div class="text-[10px] text-slate-400 uppercase">Total Size</div>
                    <div id="dataSize" class="text-sm font-semibold text-slate-700">0 MB</div>
                </div>
                <div class="bg-slate-50 p-2 rounded border border-slate-200">
                    <div class="text-[10px] text-slate-400 uppercase">Est. Time</div>
                    <div id="etr" class="text-sm font-semibold text-slate-700">--</div>
                </div>
                <div class="bg-slate-50 p-2 rounded border border-slate-200">
                    <div class="text-[10px] text-slate-400 uppercase">Status</div>
                    <div id="currentStatus" class="text-sm font-semibold text-green-600">Init</div>
                </div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden max-w-7xl mx-auto p-4 md:p-6">
        <div class="mb-6 text-center pt-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 tracking-tight">IPB Course Explorer</h1>
            <p class="text-slate-600 mt-2 text-sm md:text-base">
                Database Offline &bull; <span id="totalDataBadge" class="font-bold text-blue-600">0</span> Mata Kuliah
            </p>
        </div>

        <div class="bg-white p-4 md:p-5 rounded-xl shadow-lg border border-slate-200 sticky top-4 z-40">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">MODE PENCARIAN</label>
                    <div class="relative">
                        <i class="fa-solid fa-filter absolute left-3 top-3.5 text-slate-400"></i>
                        <select id="searchMode" onchange="updatePlaceholder()" 
                            class="w-full border border-slate-300 rounded-lg pl-9 pr-4 py-3 bg-slate-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-slate-700 appearance-none font-medium cursor-pointer">
                            <option value="ALL">üîç Semua (Smart)</option>
                            <option value="NAME">üî§ Nama Matkul</option>
                            <option value="CODE">üîñ Kode Matkul</option>
                            <option value="DESC">üìù Deskripsi</option>
                            <option value="ID_MK">üÜî ID Matkul</option>
                            <option value="ID_JADWAL">üìÖ ID Jadwal</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-3 top-4 text-xs text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                <div class="md:col-span-5">
                    <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">KATA KUNCI</label>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Cari data..." 
                            class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-slate-700 shadow-sm transition">
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">JENJANG</label>
                    <select id="strataSelect" class="w-full border border-slate-300 rounded-lg px-3 py-3 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-slate-700 cursor-pointer">
                        <option value="ALL">Semua</option>
                    </select>
                </div>
                <div class="md:col-span-2 flex items-end">
                    <button id="btnSearch" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-md active:transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-magnifying-glass"></i> CARI
                    </button>
                </div>
            </div>
        </div>

        <div id="resultsContainer" class="space-y-4 mt-6">
            <div class="text-center text-slate-400 py-20 flex flex-col items-center">
                <i class="fa-solid fa-chart-pie text-5xl mb-4 opacity-20"></i>
                <p>Cari mata kuliah untuk melihat jadwal dan statistik nilai.</p>
            </div>
        </div>
        
        <div class="text-center mt-10 mb-20">
            <button id="loadMoreBtn" class="hidden bg-white border border-slate-300 text-slate-700 px-8 py-3 rounded-full hover:bg-slate-50 shadow-md font-medium transition active:scale-95">
                Tampilkan Lebih Banyak
            </button>
        </div>
    </div>

    <script>
        // === KONFIGURASI ===
        const TOTAL_FILES = 15;
        const FILE_PREFIX = 'merged_db/db_matkul_';
        
        // === STATE ===
        let ALL_DATA = [];
        let totalBytesLoaded = 0;
        let startTime = null;
        let searchResults = [];
        let currentPage = 1;
        const LIMIT = 20;

        // === UI ELEMENTS ===
        const ui = {
            progress: document.getElementById('progressBar'),
            filesCount: document.getElementById('filesCount'),
            percentText: document.getElementById('percentText'),
            dataSize: document.getElementById('dataSize'),
            speed: document.getElementById('downloadSpeed'),
            etr: document.getElementById('etr'),
            status: document.getElementById('currentStatus'),
            overlay: document.getElementById('loadingOverlay'),
            mainApp: document.getElementById('mainApp')
        };
        
        // === LOADING LOGIC ===
        async function loadDatabase() {
            startTime = Date.now();
            ui.status.innerText = "Downloading...";
            for (let i = 1; i <= TOTAL_FILES; i++) {
                const fileName = `${FILE_PREFIX}${i}.json`;
                try {
                    const response = await fetch(fileName);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const blob = await response.blob();
                    totalBytesLoaded += blob.size;
                    const text = await blob.text();
                    const json = JSON.parse(text);
                    for(const item of json) {
                        const finalItem = item.Details ? item.Details : item;
                        if(finalItem) ALL_DATA.push(finalItem);
                    }
                    const now = Date.now();
                    const elapsedSec = (now - startTime) / 1000;
                    const bps = elapsedSec > 0 ? totalBytesLoaded / elapsedSec : 0;
                    const speedText = bps > 1024*1024 ? (bps/(1024*1024)).toFixed(1)+' MB/s' : (bps/1024).toFixed(0)+' KB/s';
                    const progressPercent = (i / TOTAL_FILES) * 100;
                    const avgSize = totalBytesLoaded / i;
                    const remSec = bps > 0 ? (avgSize * (TOTAL_FILES - i)) / bps : 0;

                    ui.progress.style.width = `${progressPercent}%`;
                    ui.percentText.innerText = `${Math.round(progressPercent)}%`;
                    ui.filesCount.innerText = `${i}/${TOTAL_FILES}`;
                    ui.speed.innerText = speedText;
                    ui.dataSize.innerText = (totalBytesLoaded / (1024*1024)).toFixed(2) + ' MB';
                    ui.etr.innerText = remSec < 1 && i < TOTAL_FILES ? '< 1s' : remSec.toFixed(0) + 's';
                } catch (err) {
                    console.error(err);
                    ui.status.innerText = "Error";
                    ui.status.classList.add('text-red-500');
                }
            }
            ui.status.innerText = "Ready";
            finishLoading();
        }

        function finishLoading() {
            setTimeout(() => {
                ui.overlay.style.opacity = '0';
                ui.overlay.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    ui.overlay.style.display = 'none';
                    ui.mainApp.classList.remove('hidden');
                    document.body.classList.remove('loading');
                    initApp();
                }, 500);
            }, 500);
        }

        function initApp() {
            document.getElementById('totalDataBadge').innerText = ALL_DATA.length.toLocaleString();
            const strataSet = new Set(ALL_DATA.map(c => c.Strata).filter(Boolean));
            const select = document.getElementById('strataSelect');
            [...strataSet].sort().forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.innerText = s;
                select.appendChild(opt);
            });
            updatePlaceholder();
        }

        // === SEARCH LOGIC ===
        window.updatePlaceholder = function() {
            const mode = document.getElementById('searchMode').value;
            const input = document.getElementById('searchInput');
            if (mode === 'ALL') input.placeholder = "Cari Kode, Nama, Deskripsi...";
            else if (mode === 'NAME') input.placeholder = "Contoh: Biologi Umum, Algoritma...";
            else if (mode === 'CODE') input.placeholder = "Contoh: BIO101, KOM120C...";
            else if (mode === 'DESC') input.placeholder = "Cari kata dalam silabus...";
            else if (mode === 'ID_MK') input.placeholder = "Masukkan ID Matkul (cth: 203198)";
            else if (mode === 'ID_JADWAL') input.placeholder = "Masukkan ID Jadwal (cth: 326777)";
        }

        document.getElementById('btnSearch').addEventListener('click', () => doSearch(true));
        document.getElementById('loadMoreBtn').addEventListener('click', () => { currentPage++; renderPage(); });
        document.getElementById('searchInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') doSearch(true); });

        function doSearch(reset = true) {
            const rawKeyword = document.getElementById('searchInput').value.toLowerCase();
            const keyword = rawKeyword.trim();
            const strataFilter = document.getElementById('strataSelect').value;
            const mode = document.getElementById('searchMode').value;
            const container = document.getElementById('resultsContainer');

            if (reset) {
                currentPage = 1;
                container.innerHTML = '';
                searchResults = ALL_DATA.filter(item => {
                    if (strataFilter !== 'ALL' && item.Strata !== strataFilter) return false;
                    if (!keyword) return true;
                    switch (mode) {
                        case 'NAME': return (item.Nama && item.Nama.toLowerCase().includes(keyword));
                        case 'CODE': return (item.Kode && item.Kode.toLowerCase().includes(keyword));
                        case 'DESC': return (item.Deskripsi && item.Deskripsi.toLowerCase().includes(keyword));
                        case 'ID_MK': return String(item.MataKuliahId).includes(keyword);
                        case 'ID_JADWAL': return item.ListJadwal && item.ListJadwal.some(j => String(j.JadwalKuliahId).includes(keyword));
                        case 'ALL': default:
                            return (item.Nama && item.Nama.toLowerCase().includes(keyword)) || 
                                   (item.Kode && item.Kode.toLowerCase().includes(keyword)) ||
                                   (item.Deskripsi && item.Deskripsi.toLowerCase().includes(keyword)) ||
                                   String(item.MataKuliahId).includes(keyword) ||
                                   (item.ListJadwal && item.ListJadwal.some(j => String(j.JadwalKuliahId).includes(keyword)));
                    }
                });

                if (searchResults.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-10 bg-white rounded-lg shadow border border-slate-200">
                            <i class="fa-regular fa-circle-xmark text-4xl text-red-300 mb-3"></i>
                            <p class="text-slate-500">Tidak ada hasil untuk "${rawKeyword}" di mode <span class="font-bold text-slate-700">${mode}</span>.</p>
                        </div>`;
                    document.getElementById('loadMoreBtn').classList.add('hidden');
                    return;
                }
            }
            renderPage();
        }

        function renderPage() {
            const container = document.getElementById('resultsContainer');
            const start = (currentPage - 1) * LIMIT;
            const end = start + LIMIT;
            const slice = searchResults.slice(start, end);

            slice.forEach(item => {
                let strataClass = 'bg-slate-100 text-slate-700';
                if(item.Strata === 'S1') strataClass = 'bg-emerald-100 text-emerald-800 border border-emerald-200';
                else if(item.Strata === 'S2') strataClass = 'bg-purple-100 text-purple-800 border border-purple-200';
                else if(item.Strata === 'D3') strataClass = 'bg-orange-100 text-orange-800 border border-orange-200';

                let jadwalHtml = '';
                if (item.ListJadwal && item.ListJadwal.length > 0) {
                    jadwalHtml = `
                    <div class="hidden mt-4 bg-slate-50 rounded-lg border border-slate-200 overflow-hidden" id="jadwal-${item.MataKuliahId}">
                        <div class="px-4 py-2 bg-slate-100 border-b border-slate-200 flex justify-between items-center">
                            <h4 class="font-bold text-slate-700 text-sm"><i class="fa-regular fa-calendar mr-2"></i>Jadwal Perkuliahan</h4>
                            <span class="text-xs text-slate-400 font-mono">Total: ${item.ListJadwal.length} Kelas</span>
                        </div>
                        <div class="p-4 space-y-3">
                            ${item.ListJadwal.map(j => {
                                const typeMap = { 'K': 'Kuliah', 'P': 'Praktikum', 'R': 'Responsi' };
                                const typeLabel = typeMap[j.JenisKelas] || j.JenisKelas || '?';
                                const typeColor = j.JenisKelas === 'P' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700';
                                return `
                                <div class="flex flex-col sm:flex-row sm:items-start gap-2 text-sm border-b border-slate-100 last:border-0 pb-2 last:pb-0">
                                    <div class="flex gap-2 items-center min-w-[140px]">
                                        <span class="font-mono text-xs bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded" title="JadwalKuliahId">#${j.JadwalKuliahId}</span>
                                        <span class="text-xs font-bold px-2 py-0.5 rounded ${typeColor}">${typeLabel}</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-semibold text-slate-700">Kelas Pararel ${j.KelasParalel}</div>
                                        <div class="text-slate-600 text-xs mt-0.5"><i class="fa-solid fa-clock text-slate-300 mr-1"></i> ${j.Jadwal.join(', ')}</div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
                } else {
                    jadwalHtml = `<div class="hidden mt-4 text-sm text-slate-400 italic p-4 bg-slate-50 rounded border border-slate-200" id="jadwal-${item.MataKuliahId}">Jadwal belum tersedia.</div>`;
                }

                // --- BAGIAN INI SUDAH DIPERBAIKI (Ganti P jadi DIV, Hapus h-40) ---
                const detailInfoHtml = `
                    <div id="info-${item.MataKuliahId}" class="hidden mt-4 bg-white border border-slate-200 rounded-lg overflow-hidden shadow-inner">
                        <div class="bg-yellow-50 px-4 py-2 border-b border-yellow-100">
                             <span class="text-sm font-bold text-yellow-800">Detail & Statistik</span>
                        </div>
                        <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="text-sm text-slate-700">
                                <div class="mb-3">
                                    <span class="font-semibold block text-slate-900 mb-1">Semester:</span> 
                                    ${item.Semester || '<span class="italic text-slate-400">Data null</span>'}
                                </div>
                                <div>
                                    <span class="font-semibold block text-slate-900 mb-1">Deskripsi Mata Kuliah:</span>
                                    <div class="desc-content leading-relaxed text-slate-600 bg-slate-50 p-3 rounded border border-slate-100 text-xs max-h-60 overflow-y-auto">
                                        ${item.Deskripsi || '<span class="italic text-slate-400">Tidak ada deskripsi tersedia.</span>'}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm mb-2"><i class="fa-solid fa-chart-simple mr-1 text-blue-500"></i> Statistik Nilai Mutu</h4>
                                <div id="chart-wrapper-${item.MataKuliahId}" class="relative h-48 w-full bg-slate-50 rounded border border-slate-100 flex items-center justify-center">
                                    <span class="text-xs text-slate-400">Data sedang dimuat...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const card = `
                    <div class="bg-white p-5 md:p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition duration-200 group">
                        <div class="flex flex-col md:flex-row md:justify-between gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2.5 py-0.5 text-xs font-bold rounded shadow-sm ${strataClass}">${item.Strata || 'N/A'}</span>
                                    <span class="text-xs text-slate-400 font-mono bg-slate-100 px-1.5 py-0.5 rounded">ID: ${item.MataKuliahId}</span>
                                </div>
                                <h3 class="text-lg md:text-xl font-bold text-slate-800 leading-tight group-hover:text-blue-700 transition">${item.Nama}</h3>
                                <div class="text-blue-600 font-mono text-sm mt-1 font-medium flex items-center gap-2">
                                    ${item.Kode} <span class="text-slate-300">|</span> <span class="text-slate-500">${item.SksNama}</span>
                                </div>
                            </div>
                            <div class="flex flex-row md:flex-col gap-2 shrink-0">
                                <button onclick="toggleInfo('${item.MataKuliahId}')" 
                                    class="flex items-center justify-center gap-2 text-xs font-semibold bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-50 transition">
                                    <i class="fa-solid fa-circle-info text-yellow-500"></i> Detail
                                </button>
                                <button onclick="toggleSection('jadwal-${item.MataKuliahId}')" 
                                    class="flex items-center justify-center gap-2 text-xs font-semibold bg-blue-50 text-blue-600 border border-blue-100 px-4 py-2 rounded-lg hover:bg-blue-100 transition">
                                    <i class="fa-regular fa-calendar-days"></i> ${item.ListJadwal ? item.ListJadwal.length : 0} Jadwal
                                </button>
                            </div>
                        </div>
                        ${detailInfoHtml}
                        ${jadwalHtml}
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', card);
            });

            const btn = document.getElementById('loadMoreBtn');
            if (end >= searchResults.length) {
                btn.classList.add('hidden');
            } else {
                btn.classList.remove('hidden');
                btn.innerText = `Muat Lagi (${searchResults.length - end} tersisa)`;
            }
        }

        window.toggleSection = function(id) {
            const el = document.getElementById(id);
            if (el.classList.contains('hidden')) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        window.toggleInfo = async function(mkId) {
            const el = document.getElementById(`info-${mkId}`);
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                const wrapper = document.getElementById(`chart-wrapper-${mkId}`);
                if (!wrapper.querySelector('canvas')) {
                    await loadChartData(mkId);
                }
            } else {
                el.classList.add('hidden');
            }
        }

        async function loadChartData(mkId) {
            const wrapper = document.getElementById(`chart-wrapper-${mkId}`);
            wrapper.innerHTML = `<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>`; 
            try {
                const res = await fetch(`https://krs.ipb.ac.id/api/StatistikNilai?mataKuliahId=${mkId}`);
                if (!res.ok) throw new Error("Gagal mengambil data");
                const data = await res.json();
                const order = ['A', 'AB', 'B', 'BC', 'C', 'D', 'E', 'BL'];
                data.sort((a, b) => order.indexOf(a.HurufMutu) - order.indexOf(b.HurufMutu));
                const labels = data.map(d => d.HurufMutu);
                const values = data.map(d => d.Jumlah);
                wrapper.innerHTML = `<canvas id="canvas-${mkId}"></canvas>`;
                const ctx = document.getElementById(`canvas-${mkId}`).getContext('2d');
                const colors = labels.map(label => {
                    if(label === 'A') return '#22c55e'; 
                    if(label === 'AB') return '#84cc16'; 
                    if(label === 'B') return '#eab308'; 
                    if(label === 'BC') return '#f97316'; 
                    if(label === 'C') return '#ef4444'; 
                    return '#94a3b8'; 
                });
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Mahasiswa',
                            data: values,
                            backgroundColor: colors,
                            borderRadius: 4,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: function(context) { return ` ${context.raw} Mahasiswa`; } } }
                        },
                        scales: {
                            y: { beginAtZero: true, grid: { display: true, drawBorder: false }, ticks: { font: { size: 10 } } },
                            x: { grid: { display: false }, ticks: { font: { weight: 'bold' } } }
                        }
                    }
                });
            } catch (err) {
                console.error(err);
                wrapper.innerHTML = `<div class="text-center px-4"><i class="fa-solid fa-triangle-exclamation text-red-400 text-2xl mb-2"></i><p class="text-xs text-red-500">Gagal memuat statistik.</p></div>`;
            }
        }

        loadDatabase();
    </script>
</body>
</html>
